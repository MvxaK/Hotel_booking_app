<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>Room Booking</title>
    <th:block layout:fragment="page-specific-head">
        <link rel="stylesheet" href="/forms.css">
        <meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">
    </th:block>
</head>
<body layout:fragment="content">

<div class="container mt-5">
    <div class="card shadow p-4 rounded">
        <h2 class="text-center mb-4 fw-bold">Book a Room</h2>

        <form id="roomBookingForm">
            <div class="mb-3">
                <label for="hotelSelect" class="form-label">Select Hotel</label>
                <select id="hotelSelect" class="form-select" required>
                    <option value="">Loading hotels...</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="roomSelect" class="form-label">Select Room</label>
                <select id="roomSelect" class="form-select" required disabled>
                    <option value="">First select a hotel</option>
                </select>
            </div>

            <div id="roomDetails" class="mb-4 p-3 bg-light rounded" style="display: none;">
                <h5 class="fw-semibold">Room Details</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Room Number:</strong> <span id="roomNumber"></span></p>
                        <p><strong>Room Type:</strong> <span id="roomType"></span></p>
                        <p><strong>Capacity:</strong> <span id="roomCapacity"></span> people</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Beds:</strong> <span id="roomBeds"></span></p>
                        <p><strong>Price:</strong> <span id="roomPrice"></span>/night</p>
                        <p><strong>Status:</strong> <span id="roomStatus" class="badge bg-success">Available</span></p>
                    </div>
                </div>
                <p class="mt-2"><strong>Description:</strong> <span id="roomDescription"></span></p>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="checkInDate" class="form-label">Check-in Date</label>
                    <input type="date" id="checkInDate" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="checkOutDate" class="form-label">Check-out Date</label>
                    <input type="date" id="checkOutDate" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Estimated Total:</label>
                <span id="totalPrice" class="fw-bold text-success fs-5">0 ₸</span>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-warning w-100 fw-semibold">Book Now</button>
        </form>
    </div>
</div>

<script>
    if (!window.roomBookingScriptInitialized) {
        window.roomBookingScriptInitialized = true;

        document.addEventListener("DOMContentLoaded", async () => {
            const hotelSelect = document.getElementById("hotelSelect");
            const roomSelect = document.getElementById("roomSelect");
            const roomDetails = document.getElementById("roomDetails");
            const totalPriceEl = document.getElementById("totalPrice");
            const form = document.getElementById("roomBookingForm");
            const submitBtn = document.getElementById("submitBtn");
            let selectedRoom = null;

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            try {
                const response = await fetch("/api/hotels");
                if (response.ok) {
                    const hotels = await response.json();
                    hotelSelect.innerHTML = '<option value="">Select a hotel</option>';
                    hotels.forEach(hotel => {
                        const opt = document.createElement("option");
                        opt.value = hotel.id;
                        opt.textContent = `${hotel.name} — ${hotel.address}`;
                        hotelSelect.appendChild(opt);
                    });
                } else {
                    hotelSelect.innerHTML = '<option>Error loading hotels</option>';
                }
            } catch (err) {
                console.error("Error loading hotels:", err);
                hotelSelect.innerHTML = '<option>Server error</option>';
            }

            function updateRoomDetails(room) {
                if (room && room.roomType) {
                    document.getElementById("roomNumber").textContent = room.roomNumber;
                    document.getElementById("roomType").textContent = room.roomType.name;
                    document.getElementById("roomCapacity").textContent = room.roomType.capacity;
                    document.getElementById("roomBeds").textContent = room.roomType.bedsCount;
                    document.getElementById("roomPrice").textContent = room.roomType.pricePerNight + ' ₸';
                    document.getElementById("roomDescription").textContent = room.roomType.description || 'No description available';

                    const statusBadge = document.getElementById("roomStatus");
                    statusBadge.textContent = room.available ? 'Available' : 'Occupied';
                    statusBadge.className = room.available ? 'badge bg-success' : 'badge bg-danger';

                    roomDetails.style.display = 'block';
                    submitBtn.disabled = !room.available;
                } else {
                    roomDetails.style.display = 'none';
                    submitBtn.disabled = true;
                }
            }

            function calculateTotal() {
                const checkIn = new Date(document.getElementById("checkInDate").value);
                const checkOut = new Date(document.getElementById("checkOutDate").value);
                if (selectedRoom && selectedRoom.roomType && checkOut > checkIn) {
                    const days = Math.ceil((checkOut - checkIn) / (1000 * 3600 * 24));
                    const total = days * selectedRoom.roomType.pricePerNight;
                    totalPriceEl.textContent = `${total.toFixed(2)} ₸`;
                } else {
                    totalPriceEl.textContent = "0 ₸";
                }
            }

            hotelSelect.addEventListener("change", async () => {
                const hotelId = hotelSelect.value;
                if (!hotelId) {
                    roomSelect.disabled = true;
                    roomSelect.innerHTML = '<option value="">First select a hotel</option>';
                    selectedRoom = null;
                    updateRoomDetails(null);
                    return;
                }

                try {
                    const response = await fetch(`/api/hotels/${hotelId}/rooms`);
                    if (response.ok) {
                        const rooms = await response.json();
                        roomSelect.disabled = false;
                        roomSelect.innerHTML = '<option value="">Select a room</option>';
                        rooms.forEach(room => {
                            const opt = document.createElement("option");
                            opt.value = room.id;
                            const status = room.available ? 'Yes' : 'No';
                            opt.textContent = `${status} Room ${room.roomNumber} — ${room.roomType?.pricePerNight || 0} ₸/night`;
                            opt.disabled = !room.available;
                            roomSelect.appendChild(opt);
                        });
                    } else {
                        roomSelect.innerHTML = '<option>Error loading rooms</option>';
                    }
                } catch (err) {
                    console.error("Error loading rooms:", err);
                    roomSelect.innerHTML = '<option>Server error</option>';
                }
            });

            roomSelect.addEventListener("change", async () => {
                const id = roomSelect.value;
                if (!id) {
                    selectedRoom = null;
                    updateRoomDetails(null);
                    return;
                }

                try {
                    const resp = await fetch(`/api/rooms/${id}`);
                    if (resp.ok) {
                        selectedRoom = await resp.json();
                        updateRoomDetails(selectedRoom);
                        calculateTotal();
                    }
                } catch (err) {
                    console.error("Error loading room details:", err);
                }
            });

            document.getElementById("checkInDate").addEventListener("change", calculateTotal);
            document.getElementById("checkOutDate").addEventListener("change", calculateTotal);

            const today = new Date().toISOString().split('T')[0];
            document.getElementById("checkInDate").min = today;
            document.getElementById("checkOutDate").min = today;

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                if (!selectedRoom) {
                    alert("Please select a room for booking!");
                    return;
                }

                if (!selectedRoom.available) {
                    alert("This room is not available for booking!");
                    return;
                }

                const checkIn = document.getElementById("checkInDate").value;
                const checkOut = document.getElementById("checkOutDate").value;

                if (!checkIn || !checkOut) {
                    alert("Please select both check-in and check-out dates!");
                    return;
                }

                const days = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 3600 * 24));
                const total = days * selectedRoom.roomType.pricePerNight;

                if (!confirm(`Confirm Booking:\nRoom: ${selectedRoom.roomNumber}\n` +
                    `Type: ${selectedRoom.roomType.name}\n` +
                    `Check-in: ${checkIn}\nCheck-out: ${checkOut}\n` +
                    `Duration: ${days} days\nTotal: ${total.toFixed(2)} ₸`)) return;

                submitBtn.disabled = true;
                submitBtn.textContent = "Booking...";

                const data = {
                    roomId: parseInt(roomSelect.value),
                    checkInDate: checkIn,
                    checkOutDate: checkOut
                };

                try {
                    const response = await fetch("/api/booking/room", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            [header]: token
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const booking = await response.json();
                        alert("Booking created successfully!");
                        form.reset();
                        totalPriceEl.textContent = "0 ₸";
                        selectedRoom = null;
                        updateRoomDetails(null);
                        roomSelect.disabled = true;
                    } else if (response.status === 403) {
                        alert("Error 403: Access denied or session expired");
                    } else {
                        const errorText = await response.text();
                        alert("Server error: " + errorText);
                    }
                } catch (err) {
                    console.error("Booking error:", err);
                    alert("Server connection error");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Book Now";
                }
            });
        });
    }
</script>
</body>
</html>