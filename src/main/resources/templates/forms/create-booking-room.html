<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</title>
    <th:block layout:fragment="page-specific-head">
        <link rel="stylesheet" href="/forms.css">
        <meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">
    </th:block>
</head>
<body layout:fragment="content" class="bg-gray-50">

<div class="container mt-5">
    <div class="card shadow-lg p-4 rounded-3">
        <h2 class="text-center mb-4 fw-bold">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</h2>

        <form id="roomBookingForm">
            <div class="mb-3">
                <label for="hotelSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–µ–ª—å</label>
                <select id="hotelSelect" class="form-select" required>
                    <option value="">–û—Ç–µ–ª—å</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="roomSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É</label>
                <select id="roomSelect" class="form-select" required disabled>
                    <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–µ–ª—å --</option>
                </select>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="checkInDate" class="form-label">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞</label>
                    <input type="date" id="checkInDate" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="checkOutDate" class="form-label">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</label>
                    <input type="date" id="checkOutDate" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞:</label>
                <span id="totalPrice" class="fw-bold text-success">0 ‚Ç∏</span>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-warning w-100 fw-semibold">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        // ‚úÖ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        if (window.roomBookingScriptInitialized) return;
        window.roomBookingScriptInitialized = true;

        const hotelSelect = document.getElementById("hotelSelect");
        const roomSelect = document.getElementById("roomSelect");
        const totalPriceEl = document.getElementById("totalPrice");
        const form = document.getElementById("roomBookingForm");
        const submitBtn = document.getElementById("submitBtn");
        let selectedRoom = null;

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–µ–ª–µ–π
        try {
            const response = await fetch("/api/hotels");
            if (response.ok) {
                const hotels = await response.json();
                hotelSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–µ–ª—å</option>';
                hotels.forEach(hotel => {
                    const opt = document.createElement("option");
                    opt.value = hotel.id;
                    opt.textContent = `${hotel.name} ‚Äî ${hotel.address}`;
                    hotelSelect.appendChild(opt);
                });
            } else {
                hotelSelect.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–µ–ª–µ–π</option>';
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–µ–ª–µ–π:", err);
            hotelSelect.innerHTML = '<option>–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</option>';
        }

        hotelSelect.addEventListener("change", async () => {
            const hotelId = hotelSelect.value;
            if (!hotelId) {
                roomSelect.disabled = true;
                roomSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–µ–ª—å</option>';
                return;
            }

            try {
                const response = await fetch(`/api/hotels/${hotelId}/rooms`);
                if (response.ok) {
                    const rooms = await response.json();
                    roomSelect.disabled = false;
                    roomSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É</option>';
                    rooms.forEach(room => {
                        const opt = document.createElement("option");
                        opt.value = room.id;
                        opt.textContent = `${room.roomNumber} ‚Äî ${room.pricePerNight} ‚Ç∏/–Ω–æ—á—å`;
                        roomSelect.appendChild(opt);
                    });
                } else {
                    roomSelect.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç</option>';
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç:", err);
                roomSelect.innerHTML = '<option>–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</option>';
            }
        });

        roomSelect.addEventListener("change", async () => {
            const id = roomSelect.value;
            if (!id) return selectedRoom = null;
            const resp = await fetch(`/api/rooms/${id}`);
            if (resp.ok) selectedRoom = await resp.json();
            calculateTotal();
        });

        function calculateTotal() {
            const checkIn = new Date(document.getElementById("checkInDate").value);
            const checkOut = new Date(document.getElementById("checkOutDate").value);
            if (selectedRoom && checkOut > checkIn) {
                const days = (checkOut - checkIn) / (1000 * 3600 * 24);
                const total = days * selectedRoom.pricePerNight;
                totalPriceEl.textContent = `${total.toFixed(2)} ‚Ç∏`;
            } else {
                totalPriceEl.textContent = "0 ‚Ç∏";
            }
        }

        document.getElementById("checkInDate").addEventListener("change", calculateTotal);
        document.getElementById("checkOutDate").addEventListener("change", calculateTotal);

        // ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!selectedRoom) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!");

            const checkIn = document.getElementById("checkInDate").value;
            const checkOut = document.getElementById("checkOutDate").value;
            const total = totalPriceEl.textContent;

            if (!confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:\n–ö–æ–º–Ω–∞—Ç–∞: ${roomSelect.options[roomSelect.selectedIndex].text}\n` +
                `–ó–∞–µ–∑–¥: ${checkIn}\n–í—ã–µ–∑–¥: ${checkOut}\n–°—É–º–º–∞: ${total}`)) return;

            // üîí –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = true;

            const data = {
                accommodationId: parseInt(roomSelect.value),
                checkInDate: checkIn,
                checkOutDate: checkOut
            };

            try {
                const response = await fetch("/api/booking", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        [header]: token
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!");
                    form.reset();
                    totalPriceEl.textContent = "0 ‚Ç∏";
                    selectedRoom = null;
                    roomSelect.disabled = true;
                } else if (response.status === 403) {
                    alert("–û—à–∏–±–∫–∞ 403: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è");
                } else {
                    const errorText = await response.text();
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + errorText);
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            } finally {
                setTimeout(() => submitBtn.disabled = false, 1500);
            }
        });
    });
</script>
</body>
</html>
